# 模块实现: 分享系统 (Sharing)

## 1. 目标
允许用户分享他们正在学习的歌曲。由于所有的媒体和歌词数据都存储在本地，分享功能不能直接分享数据本身，而是分享一个“配方”，让其他用户可以重新在他们的设备上构建相同的内容。

## 2. 原理
分享链接的核心是**指令**，而不是**内容**。一个分享链接将包含重建视图所需的最少信息。

## 3. 分享链接结构

一个典型的分享 URL 如下所示：
`https://j-melo.app/share?data={BASE64_ENCODED_JSON}`

其中，`{BASE64_ENCODED_JSON}` 是一个经过 Base64 编码的 JSON 字符串，解码后内容如下：

```json
{
  "v": 1, // 版本号
  "url": "https://www.youtube.com/watch?v=...", // 必须：原始媒体的 URL
  "title": "歌曲标题", // 可选：用于在加载时显示
  "artist": "艺术家", // 可选
  "notes": [ // 可选：分享者添加的笔记
    {
      "lineId": "lyric-line-uuid-123", // 对应歌词行的 ID
      "content": "这句的「てしまう」用法值得注意！"
    }
  ]
}
```
- **`url` (关键)**: 这是最重要的部分。接收者打开链接后，应用将使用这个 URL 重新触发“媒体获取”和“歌词生成”的完整流程。
- **`notes`**: 允许用户分享他们对特定歌词行的笔记。这增加了分享的价值。

## 4. 实现流程

### 4.1 生成分享链接
1.  在播放器界面，添加一个“分享”按钮。
2.  点击按钮后，构建上述的 JSON 对象。
    - `url`: 从当前歌曲的数据中获取 `sourceUrl`。
    - `notes`: [未来功能] 如果实现了笔记功能，则一并打包。
3.  将 JSON 对象 `JSON.stringify()`。
4.  使用 `btoa()` 函数将 JSON 字符串进行 Base64 编码。
5.  拼接成完整的 URL: `https://j-melo.app/share?data=...`。
6.  将该 URL 复制到用户的剪贴板，并显示一个“已复制到剪贴板”的提示。可以使用 `navigator.clipboard.writeText()` API。

### 4.2 处理分享链接
1.  在应用的路由中，设置一个专门处理分享的页面或路由，例如 `/share`。
2.  **页面加载时 (`useEffect`)**:
    - 从 URL query 参数中获取 `data`。
    - 使用 `atob()` 函数对 `data` 字符串进行 Base64 解码。
    - 使用 `JSON.parse()` 将解码后的字符串转换为 JSON 对象。
    - **验证数据**: 检查 `url` 字段是否存在且合法。
3.  **触发数据获取**:
    - 将解析出的 `url` 传递给应用的主流程，就好像用户在主页输入了这个 URL 一样。
    - 应用会自动开始下载媒体、转录歌词等一系列操作。
    - 在这个过程中，页面可以显示一个加载指示器，并显示分享的歌曲标题和艺术家（如果链接中提供了）。
4.  **应用笔记**:
    - 一旦歌词生成完毕，遍历分享数据中的 `notes` 数组。
    - 根据 `lineId` 找到对应的歌词行，并将笔记内容附加到该行的数据中，以便在 UI 上显示。
5.  **完成**: 数据加载和处理完成后，将用户重定向到主播放器界面。

## 5. 用户体验
- **发送者**: 分享过程应该简单快捷，一键复制链接。
- **接收者**: 打开链接后，应该有清晰的加载状态指示。例如：“正在为您准备分享的歌曲《歌曲标题》...”。整个过程应该是全自动的，无需用户额外操作。

## 6. 待办事项
- [ ] 在播放器界面添加“分享”按钮。
- [ ] 实现生成 Base64 编码的分享链接并复制到剪贴板的功能。
- [ ] 创建 `/share` 页面或路由。
- [ ] 在 `/share` 页面实现解析 URL、解码数据和验证数据的逻辑。
- [ ] 将解析出的 `url` 接入现有的媒体获取和处理流程。
- [ ] [未来] 设计并实现歌词笔记功能，并将其集成到分享数据中。
- [ ] 设计加载界面，提升接收者的体验。
